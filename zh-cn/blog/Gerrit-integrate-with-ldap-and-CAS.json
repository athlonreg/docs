{
  "filename": "Gerrit-integrate-with-ldap-and-CAS.md",
  "__html": "<h2>背景介绍</h2>\n<ul>\n<li>Gerrit 版本：2.16</li>\n<li>Gerrit URL：<a href=\"http://devops.iamzhl.top:82\">http://devops.iamzhl.top:82</a></li>\n<li>openLDAP 服务：ldap://devops.iamzhl.top:389</li>\n<li>CAS 服务：<a href=\"http://devops.iamzhl.top:8080/cas\">http://devops.iamzhl.top:8080/cas</a></li>\n</ul>\n<h2>整合 LDAP</h2>\n<h3>修改 gerrit.config</h3>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># vi /usr/local/review_site/etc/gerrit.config</span>\n</code></pre>\n<blockquote>\n<p>请根据自己的<code>LDAP</code>服务器信息进行定制</p>\n</blockquote>\n<pre><code class=\"language-properties\"><span class=\"hljs-attr\">[auth]</span>\n        <span class=\"hljs-attr\">type</span> = <span class=\"hljs-string\">LDAP</span>\n<span class=\"hljs-attr\">[ldap]</span>\n        <span class=\"hljs-attr\">server</span> = <span class=\"hljs-string\">ldap://devops.iamzhl.top:389</span>\n        <span class=\"hljs-attr\">username</span> = <span class=\"hljs-string\">cn=Manager,dc=iamzhl,dc=top</span>\n        <span class=\"hljs-attr\">password</span> = <span class=\"hljs-string\">passwd</span>\n        <span class=\"hljs-attr\">accountBase</span> = <span class=\"hljs-string\">ou=People,dc=iamzhl,dc=top</span>\n        <span class=\"hljs-attr\">groupBase</span> = <span class=\"hljs-string\">ou=People,dc=iamzhl,dc=top</span>\n        <span class=\"hljs-attr\">accountFullName</span> = <span class=\"hljs-string\">uid</span>\n</code></pre>\n<h3>重启服务</h3>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># gerrit restart</span>\n</code></pre>\n<h3>测试</h3>\n<p>打开网址<code>http://devops.iamzhl.top:8081</code>，进入到<code>Gerrit</code>主页面</p>\n<p><img src=\"https://gitee.com/athlonreg/picbed/raw/master/Images/4d/42f6d16ca0cd469d5b5bd9cfb9f471.jpg\" alt=\"\"></p>\n<p>点击右上角<code>Sign in</code>，进入登录界面，输入<code>LDAP</code>服务器中的用户名和密码，然后点击<code>Sign in</code></p>\n<p><img src=\"https://gitee.com/athlonreg/picbed/raw/master/Images/5e/3a439fb1bcfae0116018eaca7dd987.jpg\" alt=\"\"></p>\n<p>登录成功后跳转到用户主页面，正常获取用户名</p>\n<p><img src=\"https://gitee.com/athlonreg/picbed/raw/master/Images/3d/ea561210f011755f97aec7c4a90b59.jpg\" alt=\"\"></p>\n<p>点击用户名 -&gt; Sign Out，正常退出</p>\n<p><img src=\"https://gitee.com/athlonreg/picbed/raw/master/Images/4d/42f6d16ca0cd469d5b5bd9cfb9f471.jpg\" alt=\"\"></p>\n<p>至此，<code>Gerrit</code>整合<code>LDAP</code>完成。</p>\n<h2>整合 CAS</h2>\n<h3>修改 gerrit.config</h3>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># vi /usr/local/review_site/etc/gerrit.config</span>\n</code></pre>\n<p>修改<code>[auth]</code>部分</p>\n<pre><code class=\"language-properties\"><span class=\"hljs-attr\">[auth]</span>\n        <span class=\"hljs-attr\">type</span> = <span class=\"hljs-string\">HTTP</span>\n        <span class=\"hljs-attr\">httpHeader</span> = <span class=\"hljs-string\">X-Forwarded-Gerrit</span>\n        <span class=\"hljs-attr\">logoutUrl</span> = <span class=\"hljs-string\">http://devops.iamzhl.top:8080/cas/logout</span>\n</code></pre>\n<h3><code>mod_auth_cas</code>修改</h3>\n<p>然后安装<code>mod_auth_cas</code></p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># yum -y install mod_auth_cas</span>\n</code></pre>\n<p>配置<code>mod_auth_cas</code></p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># vi /etc/httpd/conf.d/auth_cas.conf</span>\n</code></pre>\n<p>修改<code>CAS</code>的<code>Cookie</code>存储位置以及登录地址和验证地址等参数如下</p>\n<pre><code class=\"language-properties\"><span class=\"hljs-attr\">LogLevel</span> <span class=\"hljs-string\">Debug</span>\n<span class=\"hljs-attr\">CASDebug</span> <span class=\"hljs-string\">On</span>\n<span class=\"hljs-attr\">CASVersion</span> <span class=\"hljs-string\">2</span>\n<span class=\"hljs-attr\">CASTimeout</span> <span class=\"hljs-string\">1740</span>\n<span class=\"hljs-attr\">CASIdleTimeout</span> <span class=\"hljs-string\">1740</span>\n<span class=\"hljs-attr\">CASSSOEnabled</span> <span class=\"hljs-string\">On</span>\n<span class=\"hljs-attr\">CASCookiePath</span> <span class=\"hljs-string\">/var/cache/httpd/mod_auth_cas/</span>\n<span class=\"hljs-attr\">CASLoginURL</span> <span class=\"hljs-string\">http://devops.iamzhl.top:8080/cas/login</span>\n<span class=\"hljs-attr\">CASValidateURL</span> <span class=\"hljs-string\">http://devops.iamzhl.top:8080/cas/serviceValidate</span>\n</code></pre>\n<h3>修改 apache 配置文件</h3>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># vi /etc/httpd/conf/httpd.conf</span>\n</code></pre>\n<blockquote>\n<p>添加反向代理</p>\n</blockquote>\n<pre><code class=\"language-properties\"><span class=\"hljs-comment\"># 添加一个监听端口 82 用作 Gerrit 的代理主机</span>\n<span class=\"hljs-attr\">Listen</span> <span class=\"hljs-string\">82</span>\n<span class=\"hljs-comment\">\n# 加载 mod_auth_cas 模块，如果已经加载请忽略</span>\n<span class=\"hljs-attr\">LoadModule</span> <span class=\"hljs-string\">auth_cas_module modules/mod_auth_cas.so</span>\n<span class=\"hljs-comment\">\n# 设置 Gerrit 的虚拟主机</span>\n<span class=\"hljs-meta\">&lt;VirtualHost</span> <span class=\"hljs-string\">*:82&gt;</span>\n    <span class=\"hljs-attr\">ServerName</span> <span class=\"hljs-string\">devops.iamzhl.top</span>\n    <span class=\"hljs-attr\">ServerAdmin</span> <span class=\"hljs-string\">15563836030@163.com</span>\n\n    <span class=\"hljs-attr\">CASRootProxiedAs</span> <span class=\"hljs-string\">http://devops.iamzhl.top:82</span>\n\n    <span class=\"hljs-attr\">ProxyRequests</span> <span class=\"hljs-string\">Off</span>\n    <span class=\"hljs-attr\">ProxyVia</span> <span class=\"hljs-string\">Off</span>\n    <span class=\"hljs-attr\">ProxyPreserveHost</span> <span class=\"hljs-string\">On</span>\n\n    <span class=\"hljs-meta\">&lt;Proxy</span> <span class=\"hljs-string\">*&gt;</span>\n          <span class=\"hljs-attr\">Order</span> <span class=\"hljs-string\">deny,allow</span>\n          <span class=\"hljs-attr\">Allow</span> <span class=\"hljs-string\">from all</span>\n    <span class=\"hljs-attr\">&lt;/Proxy&gt;</span>\n\n    <span class=\"hljs-meta\">&lt;Location</span> <span class=\"hljs-string\">\"/login/\"&gt;</span>\n        <span class=\"hljs-attr\">AuthType</span> <span class=\"hljs-string\">CAS</span>\n        <span class=\"hljs-attr\">AuthName</span> <span class=\"hljs-string\">\"Welcome To Gerrit Code Review\"</span>\n        <span class=\"hljs-attr\">Require</span> <span class=\"hljs-string\">valid-user</span>\n        <span class=\"hljs-attr\">CASAuthNHeader</span> <span class=\"hljs-string\">X-Forwarded-Gerrit</span>\n    <span class=\"hljs-attr\">&lt;/Location&gt;</span>\n\n    <span class=\"hljs-attr\">AllowEncodedSlashes</span> <span class=\"hljs-string\">On</span>\n\n    <span class=\"hljs-attr\">ProxyPass</span> <span class=\"hljs-string\">/ http://devops.iamzhl.top:8081/</span>\n    <span class=\"hljs-attr\">ProxyPassReverse</span> <span class=\"hljs-string\">/ http://devops.iamzhl.top:8081</span>\n\n    <span class=\"hljs-attr\">ErrorLog</span> <span class=\"hljs-string\">/var/log/gerrit/error.log</span>\n    <span class=\"hljs-attr\">CustomLog</span> <span class=\"hljs-string\">/var/log/gerrit/access.log common</span>\n<span class=\"hljs-attr\">&lt;/VirtualHost&gt;</span>\n</code></pre>\n<h3>重启服务</h3>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># mkdir /var/log/gerrit</span>\n<span class=\"hljs-comment\"># gerrit restart</span>\n<span class=\"hljs-comment\"># systemctl restart httpd</span>\n</code></pre>\n<h3>测试</h3>\n<p>打开网址<code>http://devops.iamzhl.top:82</code>，发现自动跳转到了<code>CAS</code>的登录界面，网址是http://devops.iamzhl.top:8080/cas/login?service=http%3a%2f%2fdevops.iamzhl.top%3a82%2f</p>\n<p><img src=\"https://gitee.com/athlonreg/picbed/raw/master/Images/dc/a298cbb27df3f031b6a75d41b8ae3b.jpg\" alt=\"\"></p>\n<p>输入用户名密码后，点击登录，登陆成功，地址是<code>http://devops.iamzhl.top:82//#/dashboard/self</code></p>\n<p><img src=\"https://gitee.com/athlonreg/picbed/raw/master/Images/6b/7e1c3e774f6d188f2a2a7203776be1.jpg\" alt=\"\"></p>\n<p>点击用户名 -&gt; Sign Out，就会登出</p>\n<p><img src=\"https://gitee.com/athlonreg/picbed/raw/master/Images/a2/726b245663641d5b6aaf1eef3e17bf.jpg\" alt=\"\"></p>\n<p>登出界面如下，地址是<code>http://devops.iamzhl.top:8080/cas/logout</code></p>\n<p><img src=\"https://gitee.com/athlonreg/picbed/raw/master/Images/e9/a067be6a85ec888bc9ab25bcf0d0e7.jpg\" alt=\"\"></p>\n<p>至此，<code>Gerrit</code>整合<code>CAS</code>单点登录完成。</p>\n",
  "link": "/zh-cn/blog/Gerrit-integrate-with-ldap-and-CAS.html",
  "meta": {
    "title": "Gerrit 整合 ldap 和 CAS 单点登录",
    "date": "2018-12-03 09:42:41",
    "password": "",
    "categories": "运维",
    "keywords": "",
    "- Gerrit": "",
    "- ldap": "",
    "- CAS": "",
    "description": "Gerrit 整合 ldap 和 CAS 单点登录",
    "tags": "",
    "photos": "",
    "- https": "//raw.githubusercontent.com/athlonreg/BlogImages/master/Images/79/114d466e1f80823db828265ede65ee.jpg"
  }
}