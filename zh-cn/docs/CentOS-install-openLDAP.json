{
  "filename": "CentOS-install-openLDAP.md",
  "__html": "<h2>简介</h2>\n<p>OpenLDAP 是轻型目录访问协议<code>Lightweight Directory Access Protocol</code> - <code>LDAP</code>的自由和开源的实现，在其<code>OpenLDAP</code>许可证下发行，并已经被包含在众多流行的<code>Linux</code>发行版中。</p>\n<h2>安装</h2>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># cd ~</span>\n<span class=\"hljs-comment\"># yum -y install openldap-servers openldap-clients</span>\n</code></pre>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/1c/02ad1e703c7187295361dbff3fad9c.jpg\" alt=\"\"></p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG</span>\n<span class=\"hljs-comment\"># chown ldap:ldap /var/lib/ldap/DB_CONFIG</span>\n<span class=\"hljs-comment\"># systemctl start slapd</span>\n<span class=\"hljs-comment\"># systemctl enable slapd</span>\n</code></pre>\n<h2>配置</h2>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># slappasswd</span>\n</code></pre>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/75/c5c970bd59e02ac7434f217a5f27a6.jpg\" alt=\"\"></p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># vi chrootpw.ldif</span>\n</code></pre>\n<pre><code class=\"language-properties\"><span class=\"hljs-comment\"># specify the password generated above for \"olcRootPW\" section</span>\n<span class=\"hljs-attr\">dn</span>: <span class=\"hljs-string\">olcDatabase={0}config,cn=config</span>\n<span class=\"hljs-attr\">changetype</span>: <span class=\"hljs-string\">modify</span>\n<span class=\"hljs-attr\">add</span>: <span class=\"hljs-string\">olcRootPW</span>\n<span class=\"hljs-attr\">olcRootPW</span>: <span class=\"hljs-string\">{SSHA}xxxxxxxxxxxxxxxxxxxxxxxx</span>\n</code></pre>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># ldapadd -Y EXTERNAL -H ldapi:/// -f chrootpw.ldif </span>\n</code></pre>\n<h2>导入基本模式</h2>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif </span>\n<span class=\"hljs-comment\"># ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif </span>\n<span class=\"hljs-comment\"># ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif </span>\n</code></pre>\n<h2>在ldap的DB中设置域名</h2>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># slappasswd </span>\n</code></pre>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/de/9a4502a39d572493b8ae8d723a08ef.jpg\" alt=\"\"></p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># vi chdomain.ldif</span>\n</code></pre>\n<pre><code class=\"language-properties\"><span class=\"hljs-comment\"># replace to your own domain name for \"dc=***,dc=***\" section</span>\n<span class=\"hljs-comment\"># specify the password generated above for \"olcRootPW\" section</span>\n<span class=\"hljs-attr\">dn</span>: <span class=\"hljs-string\">olcDatabase={1}monitor,cn=config</span>\n<span class=\"hljs-attr\">changetype</span>: <span class=\"hljs-string\">modify</span>\n<span class=\"hljs-attr\">replace</span>: <span class=\"hljs-string\">olcAccess</span>\n<span class=\"hljs-attr\">olcAccess</span>: <span class=\"hljs-string\">{0}to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth\"</span>\n  <span class=\"hljs-attr\">read</span> <span class=\"hljs-string\">by dn.base=\"cn=Manager,dc=iamzhl,dc=top\" read by * none</span>\n\n<span class=\"hljs-attr\">dn</span>: <span class=\"hljs-string\">olcDatabase={2}hdb,cn=config</span>\n<span class=\"hljs-attr\">changetype</span>: <span class=\"hljs-string\">modify</span>\n<span class=\"hljs-attr\">replace</span>: <span class=\"hljs-string\">olcSuffix</span>\n<span class=\"hljs-attr\">olcSuffix</span>: <span class=\"hljs-string\">dc=iamzhl,dc=top</span>\n\n<span class=\"hljs-attr\">dn</span>: <span class=\"hljs-string\">olcDatabase={2}hdb,cn=config</span>\n<span class=\"hljs-attr\">changetype</span>: <span class=\"hljs-string\">modify</span>\n<span class=\"hljs-attr\">replace</span>: <span class=\"hljs-string\">olcRootDN</span>\n<span class=\"hljs-attr\">olcRootDN</span>: <span class=\"hljs-string\">cn=Manager,dc=iamzhl,dc=top</span>\n\n<span class=\"hljs-attr\">dn</span>: <span class=\"hljs-string\">olcDatabase={2}hdb,cn=config</span>\n<span class=\"hljs-attr\">changetype</span>: <span class=\"hljs-string\">modify</span>\n<span class=\"hljs-attr\">add</span>: <span class=\"hljs-string\">olcRootPW</span>\n<span class=\"hljs-attr\">olcRootPW</span>: <span class=\"hljs-string\">{SSHA}xxxxxxxxxxxxxxxxxxxxxxxx</span>\n\n<span class=\"hljs-attr\">dn</span>: <span class=\"hljs-string\">olcDatabase={2}hdb,cn=config</span>\n<span class=\"hljs-attr\">changetype</span>: <span class=\"hljs-string\">modify</span>\n<span class=\"hljs-attr\">add</span>: <span class=\"hljs-string\">olcAccess</span>\n<span class=\"hljs-attr\">olcAccess</span>: <span class=\"hljs-string\">{0}to attrs=userPassword,shadowLastChange by</span>\n  <span class=\"hljs-attr\">dn</span>=<span class=\"hljs-string\">\"cn=Manager,dc=iamzhl,dc=top\" write by anonymous auth by self write by * none</span>\n<span class=\"hljs-attr\">olcAccess</span>: <span class=\"hljs-string\">{1}to dn.base=\"\" by * read</span>\n<span class=\"hljs-attr\">olcAccess</span>: <span class=\"hljs-string\">{2}to * by dn=\"cn=Manager,dc=iamzhl,dc=top\" write by * read</span>\n</code></pre>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># ldapmodify -Y EXTERNAL -H ldapi:/// -f chdomain.ldif </span>\n</code></pre>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># vi basedomain.ldif</span>\n</code></pre>\n<pre><code class=\"language-properties\"><span class=\"hljs-comment\"># replace to your own domain name for \"dc=***,dc=***\" section</span>\n<span class=\"hljs-attr\">dn</span>: <span class=\"hljs-string\">dc=iamzhl,dc=top</span>\n<span class=\"hljs-attr\">objectClass</span>: <span class=\"hljs-string\">top</span>\n<span class=\"hljs-attr\">objectClass</span>: <span class=\"hljs-string\">dcObject</span>\n<span class=\"hljs-attr\">objectclass</span>: <span class=\"hljs-string\">organization</span>\n<span class=\"hljs-attr\">o</span>: <span class=\"hljs-string\">iamzhl</span>\n<span class=\"hljs-attr\">dc</span>: <span class=\"hljs-string\">iamzhl</span>\n\n<span class=\"hljs-attr\">dn</span>: <span class=\"hljs-string\">cn=Manager,dc=iamzhl,dc=top</span>\n<span class=\"hljs-attr\">objectClass</span>: <span class=\"hljs-string\">organizationalRole</span>\n<span class=\"hljs-attr\">cn</span>: <span class=\"hljs-string\">Manager</span>\n<span class=\"hljs-attr\">description</span>: <span class=\"hljs-string\">Directory Manager</span>\n\n<span class=\"hljs-attr\">dn</span>: <span class=\"hljs-string\">ou=People,dc=iamzhl,dc=top</span>\n<span class=\"hljs-attr\">objectClass</span>: <span class=\"hljs-string\">organizationalUnit</span>\n<span class=\"hljs-attr\">ou</span>: <span class=\"hljs-string\">People</span>\n\n<span class=\"hljs-attr\">dn</span>: <span class=\"hljs-string\">ou=Group,dc=iamzhl,dc=top</span>\n<span class=\"hljs-attr\">objectClass</span>: <span class=\"hljs-string\">organizationalUnit</span>\n<span class=\"hljs-attr\">ou</span>: <span class=\"hljs-string\">Group</span>\n</code></pre>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># ldapadd -x -D cn=Manager,dc=iamzhl,dc=top -W -f basedomain.ldif </span>\n</code></pre>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/d1/46842e7f601199c0f78da4d97d30ad.jpg\" alt=\"\"></p>\n<h2>添加一个用户</h2>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># slappasswd </span>\n<span class=\"hljs-comment\"># vi ldapuser.ldif</span>\n</code></pre>\n<pre><code class=\"language-properties\"><span class=\"hljs-comment\"># create new</span>\n<span class=\"hljs-comment\"># replace to your own domain name for \"dc=***,dc=***\" section</span>\n<span class=\"hljs-attr\">dn</span>: <span class=\"hljs-string\">uid=cent,ou=People,dc=iamzhl,dc=top</span>\n<span class=\"hljs-attr\">objectClass</span>: <span class=\"hljs-string\">inetOrgPerson</span>\n<span class=\"hljs-attr\">objectClass</span>: <span class=\"hljs-string\">posixAccount</span>\n<span class=\"hljs-attr\">objectClass</span>: <span class=\"hljs-string\">shadowAccount</span>\n<span class=\"hljs-attr\">cn</span>: <span class=\"hljs-string\">Cent</span>\n<span class=\"hljs-attr\">sn</span>: <span class=\"hljs-string\">Linux</span>\n<span class=\"hljs-attr\">userPassword</span>: <span class=\"hljs-string\">{SSHA}xxxxxxxxxxxxxxxxx</span>\n<span class=\"hljs-attr\">loginShell</span>: <span class=\"hljs-string\">/bin/bash</span>\n<span class=\"hljs-attr\">uidNumber</span>: <span class=\"hljs-string\">1000</span>\n<span class=\"hljs-attr\">gidNumber</span>: <span class=\"hljs-string\">1000</span>\n<span class=\"hljs-attr\">homeDirectory</span>: <span class=\"hljs-string\">/home/cent</span>\n\n<span class=\"hljs-attr\">dn</span>: <span class=\"hljs-string\">cn=cent,ou=Group,dc=iamzhl,dc=top</span>\n<span class=\"hljs-attr\">objectClass</span>: <span class=\"hljs-string\">posixGroup</span>\n<span class=\"hljs-attr\">cn</span>: <span class=\"hljs-string\">Cent</span>\n<span class=\"hljs-attr\">gidNumber</span>: <span class=\"hljs-string\">1000</span>\n<span class=\"hljs-attr\">memberUid</span>: <span class=\"hljs-string\">cent</span>\n</code></pre>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># ldapadd -x -D cn=Manager,dc=iamzhl,dc=top -W -f ldapuser.ldif </span>\n</code></pre>\n<h2>添加本机的用户和群组到ldap目录</h2>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># vi ldapuser.sh</span>\n</code></pre>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">#</span><span class=\"bash\"> extract <span class=\"hljs-built_in\">local</span> users and groups who have 1000-9999 digit UID</span>\n<span class=\"hljs-meta\">#</span><span class=\"bash\"> replace <span class=\"hljs-string\">\"SUFFIX=***\"</span> to your own domain name</span>\n<span class=\"hljs-meta\">#</span><span class=\"bash\"> this is an example</span>\n<span class=\"hljs-meta\">#</span><span class=\"bash\">!/bin/bash</span>\n\nSUFFIX='dc=iamzhl,dc=top'\nLDIF='ldapuser.ldif'\n\necho -n &gt; $LDIF\nGROUP_IDS=()\ngrep \"x:[1-9][0-9][0-9][0-9]:\" /etc/passwd | (while read TARGET_USER\ndo\n    USER_ID=\"$(echo \"$TARGET_USER\" | cut -d':' -f1)\"\n\n    USER_NAME=\"$(echo \"$TARGET_USER\" | cut -d':' -f5 | cut -d' ' -f1,2)\"\n    [ ! \"$USER_NAME\" ] &amp;&amp; USER_NAME=\"$USER_ID\"\n\n    LDAP_SN=\"$(echo \"$USER_NAME\" | cut -d' ' -f2)\"\n    [ ! \"$LDAP_SN\" ] &amp;&amp; LDAP_SN=\"$USER_NAME\"\n\n    LASTCHANGE_FLAG=\"$(grep \"${USER_ID}:\" /etc/shadow | cut -d':' -f3)\"\n    [ ! \"$LASTCHANGE_FLAG\" ] &amp;&amp; LASTCHANGE_FLAG=\"0\"\n\n    SHADOW_FLAG=\"$(grep \"${USER_ID}:\" /etc/shadow | cut -d':' -f9)\"\n    [ ! \"$SHADOW_FLAG\" ] &amp;&amp; SHADOW_FLAG=\"0\"\n\n    GROUP_ID=\"$(echo \"$TARGET_USER\" | cut -d':' -f4)\"\n    [ ! \"$(echo \"${GROUP_IDS[@]}\" | grep \"$GROUP_ID\")\" ] &amp;&amp; GROUP_IDS=(\"${GROUP_IDS[@]}\" \"$GROUP_ID\")\n\n    echo \"dn: uid=$USER_ID,ou=People,$SUFFIX\" &gt;&gt; $LDIF\n    echo \"objectClass: inetOrgPerson\" &gt;&gt; $LDIF\n    echo \"objectClass: posixAccount\" &gt;&gt; $LDIF\n    echo \"objectClass: shadowAccount\" &gt;&gt; $LDIF\n    echo \"sn: $LDAP_SN\" &gt;&gt; $LDIF\n    echo \"givenName: $(echo \"$USER_NAME\" | awk '{print $1}')\" &gt;&gt; $LDIF\n    echo \"cn: $USER_NAME\" &gt;&gt; $LDIF\n    echo \"displayName: $USER_NAME\" &gt;&gt; $LDIF\n    echo \"uidNumber: $(echo \"$TARGET_USER\" | cut -d':' -f3)\" &gt;&gt; $LDIF\n    echo \"gidNumber: $(echo \"$TARGET_USER\" | cut -d':' -f4)\" &gt;&gt; $LDIF\n    echo \"userPassword: {crypt}$(grep \"${USER_ID}:\" /etc/shadow | cut -d':' -f2)\" &gt;&gt; $LDIF\n    echo \"gecos: $USER_NAME\" &gt;&gt; $LDIF\n    echo \"loginShell: $(echo \"$TARGET_USER\" | cut -d':' -f7)\" &gt;&gt; $LDIF\n    echo \"homeDirectory: $(echo \"$TARGET_USER\" | cut -d':' -f6)\" &gt;&gt; $LDIF\n    echo \"shadowExpire: $(passwd -S \"$USER_ID\" | awk '{print $7}')\" &gt;&gt; $LDIF\n    echo \"shadowFlag: $SHADOW_FLAG\" &gt;&gt; $LDIF\n    echo \"shadowWarning: $(passwd -S \"$USER_ID\" | awk '{print $6}')\" &gt;&gt; $LDIF\n    echo \"shadowMin: $(passwd -S \"$USER_ID\" | awk '{print $4}')\" &gt;&gt; $LDIF\n    echo \"shadowMax: $(passwd -S \"$USER_ID\" | awk '{print $5}')\" &gt;&gt; $LDIF\n    echo \"shadowLastChange: $LASTCHANGE_FLAG\" &gt;&gt; $LDIF\n    echo &gt;&gt; $LDIF\ndone\n\nfor TARGET_GROUP_ID in \"${GROUP_IDS[@]}\"\ndo\n    LDAP_CN=\"$(grep \":${TARGET_GROUP_ID}:\" /etc/group | cut -d':' -f1)\"\n\n    echo \"dn: cn=$LDAP_CN,ou=Group,$SUFFIX\" &gt;&gt; $LDIF\n    echo \"objectClass: posixGroup\" &gt;&gt; $LDIF\n    echo \"cn: $LDAP_CN\" &gt;&gt; $LDIF\n    echo \"gidNumber: $TARGET_GROUP_ID\" &gt;&gt; $LDIF\n\n    for MEMBER_UID in $(grep \":${TARGET_GROUP_ID}:\" /etc/passwd | cut -d':' -f1,3)\n    do\n        UID_NUM=$(echo \"$MEMBER_UID\" | cut -d':' -f2)\n        [ $UID_NUM -ge 1000 -a $UID_NUM -le 9999 ] &amp;&amp; echo \"memberUid: $(echo \"$MEMBER_UID\" | cut -d':' -f1)\" &gt;&gt; $LDIF\n    done\n    echo &gt;&gt; $LDIF\ndone\n)\n</code></pre>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># sh ldapuser.sh </span>\n<span class=\"hljs-comment\"># ldapadd -x -D cn=Manager,dc=iamzhl,dc=top -W -f ldapuser.ldif </span>\n</code></pre>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/d5/aaa70f4f22ad6ee40fa74bf027bd4b.jpg\" alt=\"\"></p>\n<h2>利用Apache Directory Studio进行管理</h2>\n<p>Apache Directory Studio 是一个 LDAP 的工具平台，用来连接到任何 LDAP 服务器并进行管理和开发工作。其可以实现以下功能：</p>\n<ul>\n<li>LDAP浏览器</li>\n<li>LDIF编辑器</li>\n<li>嵌入式 ApacheDS</li>\n<li>ACI编辑器</li>\n<li>属性管理</li>\n</ul>\n<p>下面以新建连接和新增用户为例进行演示</p>\n<p>如图，点击 New Connection 新建一个 ldap 连接</p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/12/d782ef026127039c48173727402ae1.jpg\" alt=\"\"></p>\n<p>依次输入连接名、主机名以及端口号后点击<code>Next</code></p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/b4/8238cc5d14bd32906fb1bf4d2fb726.jpg\" alt=\"\"></p>\n<p>再依次输入绑定的<code>DN</code>和密码后点击<code>Finish</code></p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/6d/33932a9dccd444922051239295a40e.jpg\" alt=\"\"></p>\n<p>新建一个 openLDAP 用户 test / 123456</p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/0e/e69bb807212cc32a80cb28c4b927e1.jpg\" alt=\"\"></p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/01/ab9d40ac8d216e3e2b99a287082fa7.jpg\" alt=\"\"></p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/14/de8c6a3b3854b28bca29d84e338f9f.jpg\" alt=\"\"></p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/53/287f9a9a0cfe1c25c3c66d775fb214.jpg\" alt=\"\"></p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/af/af3a63b732070ac51f27b10f6e2dca.jpg\" alt=\"\"></p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/b3/da28177e70ab2cb77421d6ae16ca95.jpg\" alt=\"\"></p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/70/749184f3907b06951093fc2a944e42.jpg\" alt=\"\"></p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/c0/5ddca5f311e7f8b2ba598480c3636e.jpg\" alt=\"\"></p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/e7/8a989532254213ac72efc235676a2a.jpg\" alt=\"\"></p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/2e/ebca96c81bd780e9b90d9bdbd3415a.jpg\" alt=\"\"></p>\n<h2>Credits</h2>\n<p>本文多处参考<a href=\"https://blog.csdn.net/wenwenxiong/article/details/76855047\">centos7下ldap服务搭建</a>，感谢<a href=\"https://blog.csdn.net/wenwenxiong\">wenwenxiong</a>的分享。</p>\n",
  "link": "/zh-cn/docs/CentOS-install-openLDAP.html",
  "meta": {
    "title": "CentOS安装部署 openLDAP",
    "date": "2018-11-24 22:17:41",
    "categories": "运维",
    "keywords": "openLDAP",
    "description": "CentOS安装部署 openLDAP",
    "tags": "openLDAP",
    "photos": "https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/08/3ae2f42f09aaee0b022ca1e9417ba1.jpg"
  }
}