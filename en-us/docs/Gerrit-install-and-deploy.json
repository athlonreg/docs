{
  "filename": "Gerrit-install-and-deploy.md",
  "__html": "<h2><cneter><code>Gerrit</code>安装配置过程</center></h2>\n<h1>安装过程如下</h1>\n<h2>步骤一：创建专用账户和工作目录</h2>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># adduser gerrit  // 创建专用账户</span>\n<span class=\"hljs-comment\"># passwd gerrit  //为专有账户设置密码</span>\n</code></pre>\n<h2>步骤二：配置<code>Java</code>环境</h2>\n<ul>\n<li>去官网下载<code>JDK</code>：<a href=\"http://www.oracle.com/technetwork/java/javase/downloads/java-archive-javase8-2177648.html\">http://www.oracle.com/technetwork/java/javase/downloads/java-archive-javase8-2177648.html</a></li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/81/1b33b7e9dbe92a1515154d0193194f.jpg\" alt=\"\"></p>\n<ul>\n<li>安装<code>JDK</code>\n将下载得到的<code>jdk-8u161-linux-x64.rpm</code>包保存到<code>Linux</code>主机</li>\n</ul>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># rpm -ivh jdk-8u161-linux-x64.rpm</span>\n</code></pre>\n<ul>\n<li>设置环境变量，编辑<code>~/.bashrc</code>，</li>\n</ul>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># vim ~/.bashrc</span>\n</code></pre>\n<p>在文件的末尾添加以下行</p>\n<pre><code>export JAVA_HOME=/usr/java/jdk1.8.0_161\nexport JRE_HOME=$JAVA_HOME/jre\nexport CLASSPATH=$JAVA_HOME/lib\nexport PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin:$CLASSPATH\n</code></pre>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/49/6ac74e90a641e355b29b9c4d17deb9.jpg\" alt=\"\"></p>\n<p>使环境配置生效</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># source ~/.bashrc</span>\n</code></pre>\n<ul>\n<li>测试<code>Java</code>环境，在终端输入：<code>java -version</code>查看是否正常显示版本信息，若显示则安装成功</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/2f/49c7d622b298ae690db3c13754c1b1.jpg\" alt=\"\"></p>\n<h2>步骤三：安装MySQL</h2>\n<p>MySQL的Server在CentOS 7上从默认软件列表中被移除了，用MariaDB来代替，所以这导致我们必须要去官网上进行下载，找到链接，用wget打开，然后再安装：</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># wget http://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm</span>\n<span class=\"hljs-comment\"># rpm -ivh mysql57-community-release-el7-9.noarch.rpm</span>\n<span class=\"hljs-comment\"># yum -y install mysql mysql-server mysql-devel</span>\n</code></pre>\n<p>启动MySQL服务</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># systemctl start mysqld</span>\n</code></pre>\n<p>获取安装MySQL时的初始密码并登录MySQL</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># grep 'temporary password' /var/log/mysqld.log</span>\n<span class=\"hljs-comment\"># mysql -u root -p</span>\n</code></pre>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/4a/a001ae2bae5a494c7329cd78a477a3.jpg\" alt=\"\"></p>\n<p>登录成功后修改密码，首先修改安全策略为0，然后将密码长度限制修改为1，最后修改密码</p>\n<pre><code class=\"language-mysql\">mysql&gt; set global validate_password_policy=0;\nmysql&gt; set global validate_password_length=1;\nmysql&gt; set password for root@localhost=password('root');\n</code></pre>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/a2/0f74ed53f3a426d1fe005228478d8f.jpg\" alt=\"\"></p>\n<p>创建gerrit用户</p>\n<pre><code class=\"language-mysql\">mysql&gt; CREATE USER 'gerrit'@'%' IDENTIFIED BY '123456';\n</code></pre>\n<p>创建gerrit要用的数据表</p>\n<pre><code class=\"language-mysql\">mysql&gt; CREATE DATABASE ReviewDB; \n</code></pre>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/d2/49b9ee020b217374593ca9bf2333b3.jpg\" alt=\"\"></p>\n<p>把ReviewDB的所有权限赋给gerrit</p>\n<pre><code class=\"language-mysql\">mysql&gt; GRANT ALL ON ReviewDB.* TO 'gerrit'@'%'; \n</code></pre>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/73/94a9f46a5dd2572e26ac02b13ec1d8.jpg\" alt=\"\"></p>\n<h2>步骤四：安装Git</h2>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># yum -y install git</span>\n</code></pre>\n<h2>步骤五：下载安装<code>gerrit</code></h2>\n<ul>\n<li>从官网下载<code>gerrit</code>，存放于<code>/home/gerrit</code>目录：</li>\n</ul>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># wget https://gerrit-releases.storage.googleapis.com/gerrit-2.15.5.war</span>\n</code></pre>\n<ul>\n<li>安装<code>gerrit</code>：</li>\n</ul>\n<p>首先切换为gerrit用户，然后运行gerrit的war包</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># su gerrit</span>\n$ <span class=\"hljs-built_in\">cd</span> \n$ java -jar gerrit-2.15.war init -d review_site\n</code></pre>\n<p>一路回车默认安装(其中的认证方式处改为HTTP)</p>\n<pre><code class=\"language-bash\">[root@centos-7 gerrit]<span class=\"hljs-comment\"># su gerrit</span>\n[gerrit@centos-7 ~]$ ll\n总用量 83864\n-rwxr-xr-x. 1 root root 85872756 8月  21 12:49 gerrit-2.14.war\n[gerrit@centos-7 ~]$ java -jar gerrit-2.15.5.war init -d review_site\nUsing secure store: com.google.gerrit.server.securestore.DefaultSecureStore\n[2018-08-21 12:51:37,463] [main] INFO  com.google.gerrit.server.config.GerritServerConfigProvider : No /home/gerrit/review_site/etc/gerrit.config; assuming defaults\n\n*** Gerrit Code Review 2.15.5\n***\n\nCreate <span class=\"hljs-string\">'/home/gerrit/review_site'</span> [Y/n]?\n\n*** Git Repositories\n***\n\nLocation of Git repositories   [git]:\n\n*** SQL Database\n***\n\nDatabase server <span class=\"hljs-built_in\">type</span>           [h2]:\n\n*** Index\n***\n\nType                           [LUCENE/?]:\n\n*** User Authentication\n***\n\nAuthentication method          [OPENID/?]: HTTP\nGet username from custom HTTP header [y/N]?\nSSO <span class=\"hljs-built_in\">logout</span> URL                 :\nEnable signed push support     [y/N]?\n\n*** Review Labels\n***\n\nInstall Verified label         [y/N]?\n\n*** Email Delivery\n***\n\nSMTP server hostname           [localhost]:\nSMTP server port               [(default)]:\nSMTP encryption                [NONE/?]:\nSMTP username                  :\n\n*** Container Process\n***\n\nRun as                         [gerrit]:\nJava runtime                   [/usr/java/jdk1.8.0_161/jre]:\nCopy gerrit-2.15.5.war to review_site/bin/gerrit.war [Y/n]?\nCopying gerrit-2.15.5.war to review_site/bin/gerrit.war\n\n*** SSH Daemon\n***\n\nListen on address              [*]:\nListen on port                 [29418]:\nGenerating SSH host key ... rsa... dsa... <span class=\"hljs-keyword\">done</span>\n\n*** HTTP Daemon\n***\n\nBehind reverse proxy           [y/N]?\nUse SSL (https://)             [y/N]?\nListen on address              [*]:\nListen on port                 [8080]:\nCanonical URL                  [http://centos-7.shared:8080/]:\n\n*** Cache\n***\n\n\n*** Plugins\n***\n\nInstalling plugins.\nInstall plugin commit-message-length-validator version v2.15.5 [y/N]?\nInstall plugin download-commands version v2.15.5 [y/N]?\nInstall plugin hooks version v2.15.5 [y/N]?\nInstall plugin replication version v2.15.5 [y/N]?\nInstall plugin reviewnotes version v2.15.5 [y/N]?\nInstall plugin singleusergroup version v2.15.5 [y/N]?\nInitializing plugins.\nNo plugins found with init steps.\n\nInitialized /home/gerrit/review_site\nExecuting /home/gerrit/review_site/bin/gerrit.sh start\nStarting Gerrit Code Review: OK\nWaiting <span class=\"hljs-keyword\">for</span> server on centos-7.shared:8080 ... OK\nOpening http://centos-7.shared:8080/<span class=\"hljs-comment\">#/admin/projects/ ...FAILED</span>\nOpen Gerrit with a JavaScript capable browser:\n  http://centos-7.shared:8080/<span class=\"hljs-comment\">#/admin/projects/</span>\n[gerrit@centos-7 ~]$\n</code></pre>\n<p>授权文件夹权限给gerrit用户：</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># chown -R gerrit:gerrit review_site </span>\n</code></pre>\n<ul>\n<li>修改<code>gerrit</code>配置文件，说明如下</li>\n</ul>\n<pre><code class=\"language-bash\">$ vim review_site/etc/gerrit.config\n</code></pre>\n<pre><code>[gerrit]\n        basePath = git                          //指定被gerrit管理的所有git库存放位置，即review_site_project/git/\n        canonicalWebUrl = http://10.211.55.19:8081/project   //指定web访问gerrit的网址//填自己的ip和端口号\n[database]\n        type = mysql                             //指定gerrit所默认数据库类型，可以选用mysql，安装并创建gerrit账户\n        database = /home/gerrit/review_site/db/ReviewDB\n[auth]\n        type = HTTP                           //指定浏览器登录gerrit时的认证方式\n[sendemail]\n        smtpServer = localhost                //局域网邮件服务器，可使用hMailSever搭建\n[container]\n        user = gerrit                             //指定gerrit所在机器的用户身份与上文创建的用户对应一致,可以是root\n        javaHome = /usr/java/jdk1.8.0_161/jre\n[sshd]\n        listenAddress = *:29418                   //指定sshd服务监听的端口号\n[httpd]\n        listenUrl = http://*:8081/                //指定http代理地址\n[cache]\n        directory = cache                        //缓存位置\n</code></pre>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/31/8e586e93c265a2f6ff36d3db0454e7.jpg\" alt=\"\"></p>\n<p>重启gerrit服务</p>\n<pre><code class=\"language-bash\">$ review_site/bin/gerrit.sh restart\n</code></pre>\n<p>设置gerrit服务开机启动</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># ln -snf /home/gerrit/review_site/bin/gerrit.sh /etc/init.d/gerrit.sh</span>\n</code></pre>\n<h2>步骤六：配置反向代理服务(nginx)</h2>\n<blockquote>\n<p>说明： 局域网本地安装，设置本地<code>repo</code>库</p>\n</blockquote>\n<h3>安装<code>nginx</code>反向代理服务器</h3>\n<ul>\n<li>安装<code>gcc-c++ pcre pcre-devel zlib zlib-devel openssl</code>：</li>\n</ul>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># yum -y install gcc-c++ pcre pcre-devel zlib zlib-devel openssl</span>\n</code></pre>\n<ul>\n<li>安装启动<code>nginx</code>并设置自启动</li>\n</ul>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span>\n<span class=\"hljs-comment\"># yum update &amp;&amp; yum -y install nginx </span>\n<span class=\"hljs-comment\"># systemctl enable nginx</span>\nCreated symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.\n<span class=\"hljs-comment\"># systemctl start nginx</span>\n</code></pre>\n<h3>配置<code>nginx</code>：</h3>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># vim /etc/nginx/conf.d/default.conf</span>\n</code></pre>\n<pre><code>server {\n    listen       82;\n    server_name  localhost;\n\n    auth_basic &quot;Welcome to Gerrit Code Review !&quot;;\n    auth_basic_user_file /home/gerrit/review_site/etc/passwd;\n\n    #charset koi8-r;\n    #access_log  /var/log/nginx/host.access.log  main;\n\n    location / {\n        #root   /usr/share/nginx/html;\n        #index  index.html index.htm index.php index.jsp;\n        proxy_pass http://127.0.0.1:8081;\n        #proxy_set_header X-Forwarded-For $remote_addr;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    }\n\n    #error_page  404              /404.html;\n\n    # redirect server error pages to the static page /50x.html\n    #\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   /usr/share/nginx/html;\n    }\n</code></pre>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/a1/7b9e070ca210075f5fec8631a40d8b.jpg\" alt=\"\"></p>\n<p>启动<code>nginx</code>服务：</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># setenforce 0                 //关闭selinux以避免造成权限问题</span>\n<span class=\"hljs-comment\"># systemctl disable firewalld  //禁用防火墙</span>\n<span class=\"hljs-comment\"># systemctl stop firewalld     //关闭防火墙</span>\n<span class=\"hljs-comment\"># systemctl start nginx</span>\n</code></pre>\n<h3>设置第一个<code>gerrit</code>用户的账号和密码</h3>\n<p>要用到htpasswd命令需要首先安装有httpd</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># yum -y install httpd</span>\n$ touch ./review_site/etc/passwd\n$ htpasswd -b ./review_site/etc/passwd gerrit 123456\n</code></pre>\n<h2>步骤七：安装配置<code>gitweb</code></h2>\n<h3>安装<code>gitweb</code>,最好在联网环境下安装，或者在离线环境下下载对应的依赖包</h3>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># yum -y install gitweb</span>\n</code></pre>\n<h3>配置<code>gitweb</code>,与<code>gerrit</code>集成</h3>\n<p>修改<code>gitweb</code>的配置文件（/etc/gitweb.conf），将配置项 &quot;$projectroot&quot;修改为<code>gerrit</code>的<code>git</code>仓库目录。</p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/35/3723767206d90e1f1fbf859d5df6ba.jpg\" alt=\"\"></p>\n<p>修改/home/gerrit/review_site/etc/gerrit.config,添加：</p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/26/432e046271c2658c8a203b86c19d5f.jpg\" alt=\"\"></p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/9d/b0b9039fc3682a7cdfae62ce5387d9.jpg\" alt=\"\"></p>\n<h3>配置gerrit权限</h3>\n<p>使用管理员账号登录<code>gerrit</code>,修改<code>All-Projects</code>的权限，为<code>refs/*</code>和<code>refs/meta/config</code>的<code>Read</code>配置项配置合适的权限。</p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/bc/d4431e93f304e1a913b244cadfd492.jpg\" alt=\"\"></p>\n<p><strong>注意：如果你是在root用户下输入上面的命令 创建了password文件到/home/gerrit/review_site/etc目录中,你会发现在登录的时候永远登录不成功,永远会得到服务器500的错误页面。原因是password文件的权限问题。我们知道,/home/gerrit/是我们之前新建的gerrit用户的,那么这个文件夹的权限是700,也就是只允许gerrit用户访问,其他组的用户是访问不了的,虽然这个文件的权限拥有root用户的所有权限,但是因为它放在700权限的文件夹下面,所以同样其他用户是访问不到的。解决方法如下</strong></p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># chown -R gerrit:gerrit /home/gerrit</span>\n</code></pre>\n<h3>重启gerrit服务和Nginx服务</h3>\n<p>重启<code>gerrit</code>和<code>nginx</code>服务</p>\n<pre><code class=\"language-bash\">$ /home/gerrit/review_site/bin/gerrit.sh restart\n<span class=\"hljs-comment\"># systemctl restart nginx</span>\n</code></pre>\n<h2>步骤八：测试</h2>\n<p>访问http://localhost，用gerrit用户登录，登录界面如下</p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/74/51196a5c04235cfbd07cf5a09e1b95.jpg\" alt=\"\"></p>\n<p><img src=\"https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/79/114d466e1f80823db828265ede65ee.jpg\" alt=\"\"></p>\n",
  "link": "/en-us/docs/Gerrit-install-and-deploy.html",
  "meta": {
    "title": "CentOS安装部署Gerrit",
    "date": "2018-08-22 11:36:45",
    "categories": "",
    "- Linux": "",
    "- 运维": "",
    "keywords": "",
    "- Gerrit": "",
    "- 代码审查": "",
    "description": "CentOS安装部署代码审查工具--Gerrit",
    "tags": "",
    "photos": "",
    "- https": "//raw.githubusercontent.com/athlonreg/BlogImages/master/Images/79/114d466e1f80823db828265ede65ee.jpg"
  }
}